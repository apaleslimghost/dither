<!doctype html>
<meta charset="utf8">

<img id="img" src="./IMG_2262.jpeg" width="640" height="480">

<canvas width="640" height="480" id="canvas"></canvas>
<canvas width="640" height="480" id="canvas2"></canvas>

<style>
	body {
		margin: 0;
	}

	canvas {
		image-rendering: pixelated;
	}
</style>

<script type="module">
	import {luminance, srgbLinear} from './src/colours.js'
	import {bayer8} from './src/bayer.js'
	import {propagateError} from './src/error-diffusion.js'
	import {generatePalette, nearestColor} from './src/palette.js'

	const /** @type {HTMLCanvasElement} */ canvas = document.getElementById('canvas')
	const /** @type {HTMLImageElement} */ img = document.getElementById('img')

	const ctx = canvas.getContext('2d')

	if(img.complete) {
		drawImage()
	} else {
		img.addEventListener('load', drawImage, {once: true})
	}

	function drawImage() {
		ctx.drawImage(img, 0, 0)
		const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height)
		const paletteSize = 64
		const spread = 255 / Math.log2(paletteSize)

		const palette = generatePalette(imageData.data, paletteSize)

		for(let index = 0; index < imageData.data.length; index += 4) {
			const x = (index / 4) % imageData.width
			const y = Math.floor((index / 4) / imageData.width)
			const bayerFactor = bayer8[(x % 8) + 8 * (y % 8)]

			const [r, g, b] = nearestColor(palette, imageData.data.slice(index, index + 4).map(c => c + spread * bayerFactor)).map(Math.round)

			const rError = imageData.data[index] - r
			const gError = imageData.data[index + 1] - g
			const bError = imageData.data[index + 2] - b

			imageData.data[index] = r
			imageData.data[index + 1] = g
			imageData.data[index + 2] = b
			imageData.data[index + 3] = 255

			propagateError(imageData, index, rError, 0)
			propagateError(imageData, index, gError, 1)
			propagateError(imageData, index, bError, 2)
		}

		ctx.putImageData(imageData, 0, 0)
	}

</script>
